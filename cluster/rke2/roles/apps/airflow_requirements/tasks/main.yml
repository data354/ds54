---
- name: Install Airflow
  when: install_airflow_requirements
  block:
    - name: Create Airflow namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ release_namespace }}"

    - name: Create Secret with machine private key
      failed_when: false
      ansible.builtin.command:
        cmd: kubectl create secret generic airflow-git-secret --from-file=gitSshKey={{ pr_key_file }} -n {{ release_namespace }}
      register: output2
      changed_when: output2.rc != 0

    - name: Get host public key
      ansible.builtin.command:
        cmd: cat {{ pr_key_file }}.pub
      register: output3
      changed_when: output3.rc != 0

    - name: Confirmation de la copie de la clé ssh sur le compte github
      ansible.builtin.pause:
        prompt: |

          {{ output3.stdout }}

          Assurer-vous d'ajouter la clé ci-dessus sur votre compte github pour créer la connection avec Airflow.
          Une fois ceci fait, appuyer entrer pour continuer l'installation.

    - name: Create Secret with machine private key
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: service-all-pod
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: service-all
          subjects:
            - kind: ServiceAccount
              name: stack-aiflow-worker
              namespace: "{{ release_namespace }}"